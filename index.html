<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CapitalRise Trading Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================= COMPLETE CSS (All Styles Combined) ================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: radial-gradient(circle at top, #1c1c35, #06060c);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            height: 60px;
            background: linear-gradient(90deg, #7f3dff, #a970ff);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            font-size: 20px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(127, 61, 255, 0.3);
        }

        .header span {
            font-size: 14px;
            opacity: .9;
        }

        .notification-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 50%;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ================= AUTH ================= */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 60px);
            padding: 20px;
        }

        .auth-box {
            width: 100%;
            max-width: 450px;
            background: #12121c;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(140, 82, 255, .6);
            border: 1px solid rgba(169, 112, 255, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #a970ff;
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #a970ff, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-form {
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a970ff;
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 14px 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #a970ff;
            box-shadow: 0 0 0 3px rgba(169, 112, 255, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(90deg, #a970ff, #7f3dff);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(127, 61, 255, 0.3);
        }

        .auth-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-link {
            color: #a970ff;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-link:hover {
            color: #ff6b9d;
            text-decoration: underline;
        }

        /* ================= DASHBOARD ================= */
        .dashboard {
            display: none;
        }

        .wrapper {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* ================= SIDEBAR ================= */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #0e0e1a, #070710);
            padding: 20px;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
            z-index: 99;
        }

        .sidebar h3 {
            color: #a970ff;
            margin-bottom: 20px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-left: 10px;
        }

        .sidebar ul {
            list-style: none;
            margin-bottom: 30px;
        }

        .sidebar li {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .sidebar li i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar li:hover {
            background: rgba(169, 112, 255, 0.1);
            border-color: rgba(169, 112, 255, 0.2);
            transform: translateX(5px);
        }

        .sidebar li.active {
            background: linear-gradient(90deg, rgba(127, 61, 255, 0.2), rgba(169, 112, 255, 0.2));
            border-color: rgba(169, 112, 255, 0.3);
        }

        .logout {
            color: #ff6b6b;
            margin-top: 20px;
        }

        /* ================= MAIN CONTENT ================= */
        .main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            width: calc(100vw - 240px);
            background: rgba(0, 0, 0, 0.02);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .page-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: white;
        }

        /* ================= DASHBOARD PAGE ================= */
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(90deg, rgba(127, 61, 255, 0.1), rgba(169, 112, 255, 0.1));
            border-radius: 20px;
            border: 1px solid rgba(169, 112, 255, 0.2);
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #a970ff, #ff6b9d);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-weight: bold;
            font-size: 28px;
            box-shadow: 0 10px 20px rgba(169, 112, 255, 0.3);
        }

        .user-details {
            flex: 1;
            min-width: 250px;
        }

        .user-details h3 {
            font-size: 22px;
            margin-bottom: 8px;
            color: white;
        }

        .user-status {
            background: linear-gradient(90deg, #1db954, #22e06d);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
        }

        /* ================= BALANCE STRIP ================= */
        .balance-strip {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .strip {
            padding: 25px;
            border-radius: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .purple {
            background: linear-gradient(135deg, #8e5bff, #b689ff);
            box-shadow: 0 10px 30px rgba(142, 91, 255, 0.3);
        }

        .green {
            background: linear-gradient(135deg, #1db954, #22e06d);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
        }

        .strip-label {
            font-size: 15px;
            opacity: 0.9;
        }

        .strip-amount {
            font-size: 28px;
            font-weight: 700;
        }

        /* ================= SUMMARY ================= */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .box {
            background: linear-gradient(135deg, rgba(20, 20, 36, 0.9), rgba(10, 10, 20, 0.9));
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(127, 61, 255, 0.3);
        }

        .box h4 {
            color: #a970ff;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .box p {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        /* ================= PACKAGES ================= */
        .packages {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .pkg {
            background: linear-gradient(135deg, rgba(18, 18, 33, 0.9), rgba(10, 10, 20, 0.9));
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .pkg:hover {
            transform: translateY(-10px);
            border-color: rgba(169, 112, 255, 0.3);
            box-shadow: 0 20px 40px rgba(127, 61, 255, 0.4);
        }

        .pkg h3 {
            color: #a970ff;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 20px;
            letter-spacing: 1px;
        }

        .pkg-price {
            font-size: 36px;
            font-weight: 700;
            margin: 20px 0;
            background: linear-gradient(90deg, #a970ff, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pkg-features {
            list-style: none;
            font-size: 14px;
            margin: 20px 0;
            opacity: .9;
            text-align: left;
        }

        .pkg-features li {
            margin: 12px 0;
            display: flex;
            align-items: center;
        }

        .pkg-features li i {
            margin-right: 12px;
            color: #a970ff;
            font-size: 16px;
        }

        .pkg-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(90deg, #a970ff, #7f3dff);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
            font-size: 16px;
        }

        .pkg-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(127, 61, 255, 0.3);
        }

        /* ================= AFFILIATE ================= */
        .affiliate {
            background: linear-gradient(135deg, rgba(20, 20, 36, 0.9), rgba(10, 10, 20, 0.9));
            padding: 30px;
            border-radius: 20px;
            margin-top: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .referral-link {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .referral-link input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 16px;
            padding: 10px;
            min-width: 200px;
        }

        .copy-btn {
            background: linear-gradient(90deg, #a970ff, #7f3dff);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 15px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .share-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 15px;
            min-width: 150px;
        }

        .telegram {
            background: linear-gradient(135deg, #0088cc, #00aced);
        }

        .whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }

        .facebook {
            background: linear-gradient(135deg, #3b5998, #4267B2);
        }

        /* ================= OTHER PAGES STYLES ================= */
        .page-content {
            background: linear-gradient(135deg, rgba(20, 20, 36, 0.9), rgba(10, 10, 20, 0.9));
            padding: 30px;
            border-radius: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.2);
            min-width: 600px;
        }

        th, td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(169, 112, 255, 0.1);
            color: #a970ff;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            padding: 15px 35px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(90deg, #a970ff, #7f3dff);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(127, 61, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(90deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(90deg, #1db954, #22e06d);
        }

        .btn-danger {
            background: linear-gradient(90deg, #ff4757, #ff6b6b);
        }

        .btn-sm {
            padding: 8px 16px !important;
            font-size: 14px !important;
            margin: 2px;
        }

        /* ================= ADMIN SIDEBAR ================= */
        .admin-sidebar {
            width: 280px;
            background: linear-gradient(180deg, #0a0a14, #05050a);
            padding: 25px;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-sidebar h3 {
            color: #ff6b9d;
            margin-bottom: 20px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ================= LOADING ================= */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(127, 61, 255, 0.1);
            border-top-color: #7f3dff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ================= TOAST NOTIFICATION ================= */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s, slideOutRight 0.3s 2.7s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        .toast.success {
            background: linear-gradient(90deg, #1db954, #22e06d);
        }

        .toast.error {
            background: linear-gradient(90deg, #ff4757, #ff6b6b);
        }

        .toast.info {
            background: linear-gradient(90deg, #a970ff, #7f3dff);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ================= MOBILE MENU ================= */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 998;
        }

        /* ================= RESPONSIVE ================= */
        @media (max-width: 992px) {
            .wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                left: -280px;
                top: 60px;
                width: 280px;
                height: calc(100vh - 60px);
                z-index: 999;
                transition: left 0.3s;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .admin-sidebar {
                left: -300px;
                width: 300px;
            }
            
            .admin-sidebar.active {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            .main {
                width: 100%;
                padding: 15px;
                margin-left: 0;
            }
            
            .balance-strip {
                grid-template-columns: 1fr;
            }
            
            .packages {
                grid-template-columns: 1fr;
            }
            
            .share-buttons {
                flex-direction: column;
            }
            
            .share-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .auth-box {
                padding: 30px 20px;
            }
            
            .summary {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .user-avatar {
                margin-right: 0;
                margin-bottom: 20px;
            }
        }

        /* ================= TASK STYLES ================= */
        .task-container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 30px;
            margin: 0 auto;
        }

        .task-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .task-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .enhanced-task-card {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .task-click-button {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
        }

        .task-click-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 117, 252, 0.4);
        }

        .task-progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ================= NOTIFICATION MODAL ================= */
        .notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .notification-item:hover {
            background: rgba(169, 112, 255, 0.2) !important;
            transform: translateX(5px);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- ================= HEADER ================= -->
<div class="header">
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    CapitalRise
    <span>Trading Platform</span>
    <button class="notification-btn" onclick="showNotificationModal()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
    </button>
</div>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<!-- ================= LOADING ================= -->
<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-size: 16px;">Loading...</p>
</div>

<!-- ================= LOGIN PAGE ================= -->
<div id="loginPage" class="auth-container">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Login Your Account</h2>
            <p>Enter your credentials to access your dashboard</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
            </div>
            
            <button class="auth-btn" onclick="loginUser()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="auth-footer">
                <p style="margin-top: 15px;">
                    Don't have any account, just 
                    <span class="auth-link" onclick="showRegister()">Register</span>
                </p>
                <p style="margin-top: 15px;">
                    <span class="auth-link" onclick="showAdminLogin()">Admin Login</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= REGISTER PAGE ================= -->
<div id="registerPage" class="auth-container" style="display:none">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Register on CapitalRise</h2>
            <p>Create your account to start trading</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="regFullName">Full Name</label>
                <input type="text" id="regFullName" class="form-control" placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email Address</label>
                <input type="email" id="regEmail" class="form-control" placeholder="Enter your email address">
            </div>
            
            <div class="form-group">
                <label for="regMobile">Mobile Number</label>
                <input type="tel" id="regMobile" class="form-control" placeholder="Enter your mobile number">
            </div>
            
            <div class="form-group">
                <label for="regPassword">Create Login Password</label>
                <input type="password" id="regPassword" class="form-control" placeholder="Create a strong password">
            </div>
            
            <div class="form-group">
                <label for="regSponsorID">Sponsor ID (Optional)</label>
                <input type="text" id="regSponsorID" class="form-control" placeholder="Enter sponsor ID if any">
            </div>
            
            <button class="auth-btn" onclick="registerUser()">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
            
            <div class="auth-footer">
                <p>
                    If you are already with us, just 
                    <span class="auth-link" onclick="showLogin()">log in</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= ADMIN LOGIN PAGE ================= -->
<div id="adminLoginPage" class="auth-container" style="display:none">
    <div class="auth-box">
        <div class="auth-header">
            <h2>Super Admin Login</h2>
            <p>Access restricted to Super Admin only</p>
        </div>
        
        <div class="auth-form">
            <div class="form-group">
                <label for="adminEmail">Email Address</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="Enter admin email">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
            </div>
            
            <button class="auth-btn" onclick="adminLogin()">
                <i class="fas fa-lock"></i> Super Admin Login
            </button>
            
            <div class="auth-footer">
                <p>
                    User? 
                    <span class="auth-link" onclick="showLogin()">User Login</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ================= USER DASHBOARD ================= -->
<div class="dashboard" id="dashboard">
<div class="wrapper">

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <div>
        <h3>Menu</h3>
        <ul>
            <li class="active" onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</li>
            <li onclick="showPage('activationPage')"><i class="fas fa-bolt"></i> Activation</li>
            <li onclick="showPage('activationHistoryPage')"><i class="fas fa-history"></i> Activation History</li>
        </ul>
        
        <h3>Profile</h3>
        <ul>
            <li onclick="showPage('profilePage')"><i class="fas fa-user"></i> Profile</li>
            <li onclick="showPage('kycPage')"><i class="fas fa-id-card"></i> KYC</li>
            <li onclick="showPage('changePasswordPage')"><i class="fas fa-key"></i> Change Password</li>
        </ul>
        
        <h3>Fund Management</h3>
        <ul>
            <li onclick="showPage('addFundPage')"><i class="fas fa-plus-circle"></i> Add Fund</li>
            <li onclick="showPage('fundReportPage')"><i class="fas fa-file-alt"></i> Fund Report</li>
        </ul>
        
        <h3>Wallet</h3>
        <ul>
            <li onclick="showPage('withdrawalPage')"><i class="fas fa-wallet"></i> Withdrawal</li>
            <li onclick="showPage('withdrawalReportPage')"><i class="fas fa-file-invoice-dollar"></i> Withdrawal Report</li>
            <li onclick="showPage('taskPage')"><i class="fas fa-tasks"></i> Task</li>
        </ul>
        
        <ul>
            <li class="logout" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Logout</li>
        </ul>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">
    <!-- Dashboard Page -->
    <div class="page active" id="dashboardPage">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <h3 id="userName">User</h3>
                <p>ID: <span id="userId">USER0001</span> • Join Date: <span id="joinDate">01/01/2024</span></p>
                <p>Referrals: <strong id="referralCount">0</strong> • Rank: <strong id="userRank">Beginner</strong></p>
            </div>
            <div class="user-status" id="userStatusBadge">Active</div>
        </div>

        <div class="balance-strip">
            <div class="strip purple">
                <div>
                    <div class="strip-label">Available Balance</div>
                    <div class="strip-amount" id="userBalance">₹0</div>
                </div>
                <i class="fas fa-wallet strip-icon"></i>
            </div>
            <div class="strip green">
                <div>
                    <div class="strip-label">Active Fund</div>
                    <div class="strip-amount" id="userFund">₹0</div>
                </div>
                <i class="fas fa-chart-line strip-icon"></i>
            </div>
        </div>

        <div class="summary">
            <div class="box">
                <h4>Total Income</h4>
                <p id="totalIncome">₹0</p>
                <div class="box-trend"><i class="fas fa-arrow-up"></i> ₹0 Today</div>
            </div>
            <div class="box">
                <h4>Today's Income</h4>
                <p id="todayIncome">₹0</p>
                <div class="box-trend"><i class="fas fa-sync"></i> Updated Now</div>
            </div>
            <div class="box">
                <h4>Referral Income</h4>
                <p id="referralIncome">₹0</p>
                <div class="box-trend"><i class="fas fa-users"></i> 0 Active</div>
            </div>
            <div class="box">
                <h4>Total Tasks</h4>
                <p id="totalTasks">0</p>
                <div class="box-trend"><i class="fas fa-tasks"></i> 0 Completed</div>
            </div>
        </div>

        <div class="packages-section">
            <h3 class="section-title">Investment Packages</h3>
            
            <div class="packages">
                <!-- Package 1 - Bronze -->
                <div class="pkg">
                    <h3>BRONZE</h3>
                    <div class="pkg-price">₹1,000</div>
                    <ul class="pkg-features">
                        <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
                        <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                        <li><i class="fas fa-check-circle"></i> Investment Package</li>
                        <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                        <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
                    </ul>
                    <button class="pkg-btn" onclick="activatePackage(1000, 'BRONZE')">
                        <i class="fas fa-bolt"></i> Activate ID
                    </button>
                </div>

                <!-- Package 2 - Silver -->
                <div class="pkg">
                    <h3>SILVER</h3>
                    <div class="pkg-price">₹5,000</div>
                    <ul class="pkg-features">
                        <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
                        <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                        <li><i class="fas fa-check-circle"></i> Extra Rewards</li>
                        <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                        <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
                    </ul>
                    <button class="pkg-btn" onclick="activatePackage(5000, 'SILVER')">
                        <i class="fas fa-bolt"></i> Activate ID
                    </button>
                </div>

                <!-- Package 3 - Gold -->
                <div class="pkg">
                    <h3>GOLD</h3>
                    <div class="pkg-price">₹10,000</div>
                    <ul class="pkg-features">
                        <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
                        <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                        <li><i class="fas fa-check-circle"></i> VIP Support</li>
                        <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                        <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
                    </ul>
                    <button class="pkg-btn" onclick="activatePackage(10000, 'GOLD')">
                        <i class="fas fa-bolt"></i> Activate ID
                    </button>
                </div>

                <!-- Package 4 - Diamond -->
                <div class="pkg">
                    <h3>DIAMOND</h3>
                    <div class="pkg-price">₹50,000</div>
                    <ul class="pkg-features">
                        <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
                        <li><i class="fas fa-check-circle"></i> Referral Bonus: 10%</li>
                        <li><i class="fas fa-check-circle"></i> Special Bonuses</li>
                        <li><i class="fas fa-check-circle"></i> Daily Tasks Available</li>
                        <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
                    </ul>
                    <button class="pkg-btn" onclick="activatePackage(50000, 'DIAMOND')">
                        <i class="fas fa-bolt"></i> Activate ID
                    </button>
                </div>
            </div>
        </div>

        <div class="affiliate">
            <h3>Affiliate Program</h3>
            <p style="margin-bottom: 20px; opacity: 0.9; font-size: 15px;">
                <i class="fas fa-hand-point-right"></i> Your Referral Link - Earn 10% commission
            </p>
            <div class="referral-link">
                <input type="text" id="refLink" value="Loading..." readonly>
                <button class="copy-btn" onclick="copyReferralLink()">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="share-buttons">
                <button class="share-btn telegram" onclick="shareOnTelegram()">
                    <i class="fab fa-telegram"></i> Telegram
                </button>
                <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook"></i> Facebook
                </button>
            </div>
        </div>
    </div>

    <!-- Activation Page -->
    <div class="page" id="activationPage">
        <div class="page-header">
            <h2>Account Activation</h2>
            <p>Activate your trading account with a package</p>
        </div>
        
        <div class="page-content">
            <h3 style="color:#a970ff; margin-bottom:20px;">Select Package to Activate</h3>
            
            <div class="form-group">
                <label>Package Selection</label>
                <select id="activationPackageSelect" class="form-control" onchange="updateActivationDetails()">
                    <option value="1000">BRONZE - ₹1,000</option>
                    <option value="5000">SILVER - ₹5,000</option>
                    <option value="10000">GOLD - ₹10,000</option>
                    <option value="50000">DIAMOND - ₹50,000</option>
                </select>
            </div>
            
            <div id="activationDetails" style="background:rgba(169,112,255,0.1); padding:20px; border-radius:12px; margin:20px 0;">
                <h4 style="color:#a970ff; margin-bottom:15px;">Package Benefits:</h4>
                <div class="pkg-features">
                    <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
                    <li><i class="fas fa-check-circle"></i> Referral Commission: 10%</li>
                    <li><i class="fas fa-check-circle"></i> Withdrawal in 24-48 hours</li>
                    <li><i class="fas fa-check-circle"></i> Daily 15 Clicks Task</li>
                    <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
                </div>
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn" onclick="activateSelectedPackage()" style="width:200px;">
                    <i class="fas fa-bolt"></i> Activate Now
                </button>
            </div>
        </div>
    </div>

    <!-- Activation History Page -->
    <div class="page" id="activationHistoryPage">
        <div class="page-header">
            <h2>Activation History</h2>
            <p>View all your package activations</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Package ID</th>
                            <th>Package</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Validity Till</th>
                        </tr>
                    </thead>
                    <tbody id="activationHistoryTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div class="page" id="profilePage">
        <div class="page-header">
            <h2>My Profile</h2>
            <p>View and update your profile information</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="profileName" class="form-control" placeholder="Full Name">
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="profileEmail" class="form-control" placeholder="Email Address" readonly>
            </div>
            
            <div class="form-group">
                <label>Mobile Number</label>
                <input type="tel" id="profileMobile" class="form-control" placeholder="Mobile Number">
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn" onclick="updateProfile()">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </div>
        </div>
    </div>

    <!-- KYC Page -->
    <div class="page" id="kycPage">
        <div class="page-header">
            <h2>KYC Verification</h2>
            <p>Complete KYC for higher withdrawal limits</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Aadhar Number</label>
                <input type="text" id="aadharNumber" class="form-control" placeholder="Enter 12-digit Aadhar number">
            </div>
            
            <div class="form-group">
                <label>PAN Number</label>
                <input type="text" id="panNumber" class="form-control" placeholder="Enter PAN number">
            </div>
            
            <div class="form-group">
                <label>Bank Account Number</label>
                <input type="text" id="bankAccount" class="form-control" placeholder="Enter bank account number">
            </div>
            
            <div class="form-group">
                <label>IFSC Code</label>
                <input type="text" id="ifscCode" class="form-control" placeholder="Enter IFSC code">
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-success" onclick="submitKYC()">
                    <i class="fas fa-id-card"></i> Submit KYC
                </button>
            </div>
            
            <div id="kycStatus" style="margin-top:30px; padding:20px; border-radius:12px; display:none;">
                <!-- KYC Status will be shown here -->
            </div>
        </div>
    </div>

    <!-- Change Password Page -->
    <div class="page" id="changePasswordPage">
        <div class="page-header">
            <h2>Change Password</h2>
            <p>Update your account password</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
            </div>
            
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
            </div>
            
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn" onclick="changePassword()">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </div>
        </div>
    </div>

    <!-- Add Fund Page -->
    <div class="page" id="addFundPage">
        <div class="page-header">
            <h2>Add Funds</h2>
            <p>Deposit money to your account</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Amount to Deposit (₹)</label>
                <input type="number" id="depositAmount" class="form-control" placeholder="Enter amount" min="100">
            </div>
            
            <div class="form-group">
                <label>Payment Method</label>
                <select id="paymentMethod" class="form-control">
                    <option value="upi">UPI</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="paytm">PayTM</option>
                    <option value="phonepe">PhonePe</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Transaction ID (Optional)</label>
                <input type="text" id="transactionId" class="form-control" placeholder="Enter transaction ID if any">
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-success" onclick="submitDeposit()">
                    <i class="fas fa-money-bill-wave"></i> Submit Deposit Request
                </button>
            </div>
            
            <div id="paymentDetails" style="margin-top:30px; padding:20px; background:rgba(169,112,255,0.1); border-radius:12px; display:none;">
                <h4 style="color:#a970ff; margin-bottom:15px;">Payment Details:</h4>
                <!-- Payment details will be shown here -->
            </div>
        </div>
    </div>

    <!-- Fund Report Page -->
    <div class="page" id="fundReportPage">
        <div class="page-header">
            <h2>Fund Report</h2>
            <p>View all your deposit transactions</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="fundReportTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Withdrawal Page -->
    <div class="page" id="withdrawalPage">
        <div class="page-header">
            <h2>Withdraw Funds</h2>
            <p>Withdraw money to your bank account</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Available Balance</label>
                <input type="text" id="availableBalance" class="form-control" readonly>
            </div>
            
            <div class="form-group">
                <label>Withdrawal Amount (₹)</label>
                <input type="number" id="withdrawalAmount" class="form-control" placeholder="Enter amount" min="100">
            </div>
            
            <div class="form-group">
                <label>Withdrawal Method</label>
                <select id="withdrawalMethod" class="form-control">
                    <option value="bank">Bank Transfer</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-success" onclick="submitWithdrawal()">
                    <i class="fas fa-wallet"></i> Request Withdrawal
                </button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Report Page -->
    <div class="page" id="withdrawalReportPage">
        <div class="page-header">
            <h2>Withdrawal Report</h2>
            <p>View all your withdrawal transactions</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Transaction ID</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalReportTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Task Page -->
    <div class="page" id="taskPage">
        <div class="page-header">
            <h2>Daily Tasks</h2>
            <p>Complete tasks to earn daily income</p>
        </div>
        
        <div class="page-content">
            <div class="task-container">
                <div class="task-header">
                    <h1>Daily Tasks</h1>
                    <p>Complete 15 clicks daily to earn 5% of your investment</p>
                </div>
                
                <div class="enhanced-task-card" id="enhanced-click-task">
                    <div class="task-title-row">
                        <div class="task-checkbox" id="enhanced-task-checkbox"></div>
                        <h3>Click 15 Times</h3>
                    </div>
                    
                    <button class="task-click-button" id="task-click-button" onclick="handleTaskClick()">Click Here</button>
                    
                    <div class="task-progress" id="task-progress-text">Progress: 0/15 clicks</div>
                    
                    <div class="task-progress-bar">
                        <div class="task-progress-fill" id="task-progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Other pages would follow similar structure -->
</div>
</div>
</div>

<!-- ================= ADMIN DASHBOARD ================= -->
<div id="adminDashboard" class="dashboard" style="display:none">
<div class="wrapper">

<!-- ADMIN SIDEBAR -->
<div class="sidebar admin-sidebar" id="adminSidebar">
    <div>
        <h3>Admin Menu</h3>
        <ul>
            <li class="active" onclick="showAdminPage('adminDashboardPage')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
            <li onclick="showAdminPage('adminUsersPage')"><i class="fas fa-users"></i> All Users</li>
            <li onclick="showAdminPage('adminDepositsPage')"><i class="fas fa-money-bill-wave"></i> Deposit Requests</li>
            <li onclick="showAdminPage('adminWithdrawalsPage')"><i class="fas fa-wallet"></i> Withdrawal Requests</li>
            <li onclick="showAdminPage('adminTransactionsPage')"><i class="fas fa-exchange-alt"></i> All Transactions</li>
            <li onclick="showAdminPage('adminSettingsPage')"><i class="fas fa-cog"></i> Settings</li>
            <li onclick="showAdminPage('adminNotificationsPage')"><i class="fas fa-bell"></i> Send Notifications</li>
        </ul>
        
        <ul>
            <li class="logout" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Logout</li>
        </ul>
    </div>
</div>

<!-- ADMIN MAIN CONTENT -->
<div class="main">
    <!-- Admin Dashboard Page -->
    <div class="page active" id="adminDashboardPage">
        <div class="page-header">
            <h2>Admin Dashboard</h2>
            <p>Welcome to CapitalRise Admin Panel</p>
        </div>

        <div class="summary">
            <div class="box">
                <h4>Total Users</h4>
                <p id="adminTotalUsers">0</p>
                <div class="box-trend"><i class="fas fa-user-plus"></i> <span id="adminTodayUsers">0</span> Today</div>
            </div>
            <div class="box">
                <h4>Total Deposits</h4>
                <p id="adminTotalDeposits">₹0</p>
                <div class="box-trend"><i class="fas fa-arrow-up"></i> <span id="adminTodayDeposits">₹0</span> Today</div>
            </div>
            <div class="box">
                <h4>Total Withdrawals</h4>
                <p id="adminTotalWithdrawals">₹0</p>
                <div class="box-trend"><i class="fas fa-arrow-down"></i> <span id="adminPendingWithdrawals">0</span> Pending</div>
            </div>
            <div class="box">
                <h4>Platform Balance</h4>
                <p id="adminPlatformBalance">₹0</p>
                <div class="box-trend"><i class="fas fa-coins"></i> Net Profit</div>
            </div>
        </div>

        <div class="table-container">
            <h3 style="margin-bottom:15px; color:#a970ff;">Recent Activities</h3>
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Balance</th>
                        <th>Package</th>
                        <th>Status</th>
                        <th>Join Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminUsersList">
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Users Page -->
    <div class="page" id="adminUsersPage">
        <div class="page-header">
            <h2>All Users</h2>
            <p>Manage all registered users</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Mobile</th>
                            <th>Balance</th>
                            <th>Package</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allUsersTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Deposits Page -->
    <div class="page" id="adminDepositsPage">
        <div class="page-header">
            <h2>Deposit Requests</h2>
            <p>Approve or reject deposit requests</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Transaction ID</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminDepositsTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Withdrawals Page -->
    <div class="page" id="adminWithdrawalsPage">
        <div class="page-header">
            <h2>Withdrawal Requests</h2>
            <p>Approve or reject withdrawal requests</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Account Details</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminWithdrawalsTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Transactions Page -->
    <div class="page" id="adminTransactionsPage">
        <div class="page-header">
            <h2>All Transactions</h2>
            <p>View all platform transactions</p>
        </div>
        
        <div class="page-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="adminTransactionsTable">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin Settings Page -->
    <div class="page" id="adminSettingsPage">
        <div class="page-header">
            <h2>Admin Settings</h2>
            <p>Configure platform settings</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Platform Name</label>
                <input type="text" id="platformName" class="form-control" value="CapitalRise">
            </div>
            
            <div class="form-group">
                <label>Minimum Deposit (₹)</label>
                <input type="number" id="minDeposit" class="form-control" value="100">
            </div>
            
            <div class="form-group">
                <label>Minimum Withdrawal (₹)</label>
                <input type="number" id="minWithdrawal" class="form-control" value="100">
            </div>
            
            <div class="form-group">
                <label>Daily Task Reward (%)</label>
                <input type="number" id="taskReward" class="form-control" value="5" step="0.1">
            </div>
            
            <div class="form-group">
                <label>Referral Commission (%)</label>
                <input type="number" id="referralCommission" class="form-control" value="10" step="0.1">
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-success" onclick="saveAdminSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Notifications Page -->
    <div class="page" id="adminNotificationsPage">
        <div class="page-header">
            <h2>Send Notifications</h2>
            <p>Send notifications to users</p>
        </div>
        
        <div class="page-content">
            <div class="form-group">
                <label>Select Users</label>
                <select id="notificationUsers" class="form-control">
                    <option value="all">All Users</option>
                    <option value="active">Active Users Only</option>
                    <option value="inactive">Inactive Users Only</option>
                    <option value="specific">Specific User</option>
                </select>
            </div>
            
            <div class="form-group" id="specificUserDiv" style="display:none;">
                <label>Select Specific User</label>
                <select id="specificUser" class="form-control">
                    <!-- Users will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Notification Title</label>
                <input type="text" id="notificationTitle" class="form-control" placeholder="Enter notification title">
            </div>
            
            <div class="form-group">
                <label>Notification Message</label>
                <textarea id="notificationMessage" class="form-control" rows="4" placeholder="Enter notification message"></textarea>
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn btn-success" onclick="sendAdminNotification()">
                    <i class="fas fa-paper-plane"></i> Send Notification
                </button>
            </div>
        </div>
    </div>
</div>
</div>
</div>

<!-- ================= NOTIFICATION MODAL ================= -->
<div class="notification-modal" id="notificationModal">
    <div style="
        background: #12121c;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        border-radius: 20px;
        padding: 25px;
        border: 1px solid rgba(169, 112, 255, 0.2);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        overflow-y: auto;
        animation: modalFadeIn 0.3s;
    ">
        <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        ">
            <h3 style="color: #a970ff; margin: 0;">Notifications</h3>
            <button onclick="closeNotificationModal()" style="
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
            ">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="notificationsList" style="min-height: 200px;">
            <!-- Notifications will be loaded here -->
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="markAllNotificationsAsRead()" style="
                background: linear-gradient(90deg, #a970ff, #7f3dff);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                width: 100%;
            ">
                <i class="fas fa-check-double"></i> Mark All as Read
            </button>
        </div>
    </div>
</div>

<script>
// ================= FIREBASE CONFIGURATION =================
const firebaseConfig = {
    apiKey: "AIzaSyCYuY0_w29D9FwPyiE0c3Qo82RAF753vHE",
    authDomain: "capitalrise-78bb2.firebaseapp.com",
    databaseURL: "https://capitalrise-78bb2-default-rtdb.firebaseio.com",
    projectId: "capitalrise-78bb2",
    storageBucket: "capitalrise-78bb2.appspot.com",
    messagingSenderId: "675847702668",
    appId: "1:675847702668:web:37275e7906d680496813a9"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// ================= GLOBAL VARIABLES =================
let currentUser = null;
let currentAdmin = null;
let userData = null;
let taskClickCount = 0;
const taskTotalClicksNeeded = 15;
let notificationCount = 0;
let notifications = [];

// ================= INITIALIZATION =================
document.addEventListener('DOMContentLoaded', function() {
    // Demo credentials
    document.getElementById('loginEmail').value = 'demo@example.com';
    document.getElementById('loginPassword').value = '123456';
    document.getElementById('adminEmail').value = 'admin@capitalrise.com';
    document.getElementById('adminPassword').value = 'admin123';
    
    // Check authentication state
    auth.onAuthStateChanged((user) => {
        if (user) {
            checkUserRole(user.uid);
        } else {
            showLogin();
        }
    });
    
    // Initialize notification system
    initNotificationSystem();
});

// ================= AUTH FUNCTIONS =================
function showLogin() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('adminLoginPage').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
}

function showRegister() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'flex';
    document.getElementById('adminLoginPage').style.display = 'none';
}

function showAdminLogin() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('adminLoginPage').style.display = 'flex';
}

async function checkUserRole(uid) {
    try {
        // Check if user is admin
        const adminSnapshot = await database.ref('admins').child(uid).once('value');
        if (adminSnapshot.exists()) {
            currentAdmin = adminSnapshot.val();
            showAdminDashboard();
            updateAdminDashboard();
            showToast('Admin login successful!', 'success');
            return;
        }
        
        // Check if user exists
        const userSnapshot = await database.ref('users').child(uid).once('value');
        if (userSnapshot.exists()) {
            userData = userSnapshot.val();
            currentUser = { uid: uid, email: userData.email };
            showDashboard();
            updateDashboard();
            showToast(`Welcome back, ${userData.name}!`, 'success');
        }
    } catch (error) {
        console.error("Error checking user role:", error);
    }
}

async function registerUser() {
    const name = document.getElementById('regFullName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const mobile = document.getElementById('regMobile').value.trim();
    const password = document.getElementById('regPassword').value;
    const sponsorId = document.getElementById('regSponsorID').value.trim().toUpperCase();
    
    if (!name || !email || !mobile || !password) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
    
    showLoading();
    
    try {
        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Generate user ID
        const userCounterRef = database.ref('userCounter');
        const counterSnapshot = await userCounterRef.once('value');
        let userCounter = counterSnapshot.val() || 1;
        const userId = 'USER' + String(userCounter).padStart(4, '0');
        
        // Create user data
        userData = {
            uid: user.uid,
            name: name,
            userId: userId,
            email: email,
            mobile: mobile,
            joinDate: new Date().toLocaleDateString('en-US'),
            joinTimestamp: Date.now(),
            balance: 50, // Registration bonus
            fund: 0,
            status: "Active",
            package: "None",
            kyc: "Pending",
            totalIncome: 0,
            todayIncome: 0,
            referralIncome: 0,
            totalTasks: 0,
            referrals: 0,
            rank: "Beginner",
            activationHistory: {},
            dailyTasks: {
                lastTaskDate: "",
                clicksCompleted: 0,
                todayIncome: 0
            },
            sponsorId: sponsorId || "CAPITAL01",
            kycDetails: {},
            deposits: {},
            withdrawals: {},
            transactions: {}
        };
        
        // Save user data
        await database.ref('users').child(user.uid).set(userData);
        
        // Update user counter
        await userCounterRef.set(userCounter + 1);
        
        // Save to admin logs (सभी डेटा एडमिन के पास जाएगा)
        await database.ref('adminLogs/users').child(user.uid).set({
            ...userData,
            registrationTimestamp: Date.now(),
            registeredBy: "Self"
        });
        
        // Create transaction record for admin
        await database.ref('adminTransactions').push().set({
            type: 'registration',
            userId: user.uid,
            userName: name,
            userEmail: email,
            userMobile: mobile,
            amount: 50,
            description: 'Registration Bonus',
            timestamp: Date.now(),
            status: 'completed'
        });
        
        // Send notification to admin
        await createNotification('registration', {
            userId: user.uid,
            userName: name,
            amount: 50,
            userId: userId
        });
        
        hideLoading();
        showToast(`Registration successful! Welcome ${name}. ₹50 bonus added.`, 'success');
        
        // Automatically login
        currentUser = { uid: user.uid, email: email };
        showDashboard();
        updateDashboard();
        
    } catch (error) {
        hideLoading();
        showToast(`Registration failed: ${error.message}`, 'error');
    }
}

async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
    }
    
    showLoading();
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        hideLoading();
        showToast(`Login failed: ${error.message}`, 'error');
    }
}

async function adminLogin() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    
    if (email === 'admin@capitalrise.com' && password === 'admin123') {
        showLoading();
        
        try {
            // Create admin user if not exists
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Save admin data
            await database.ref('admins').child(user.uid).set({
                email: email,
                name: 'Super Admin',
                role: 'superadmin',
                createdAt: new Date().toISOString(),
                lastLogin: Date.now()
            });
            
            hideLoading();
            showToast('Super Admin login successful!', 'success');
        } catch (error) {
            // If user already exists, sign in
            if (error.code === 'auth/email-already-in-use') {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (signInError) {
                    hideLoading();
                    showToast(`Admin login failed: ${signInError.message}`, 'error');
                }
            } else {
                hideLoading();
                showToast(`Admin login failed: ${error.message}`, 'error');
            }
        }
    } else {
        showToast('Invalid admin credentials', 'error');
    }
}

function logoutUser() {
    auth.signOut();
    showToast('Logged out successfully', 'success');
}

function logoutAdmin() {
    auth.signOut();
    showToast('Admin logged out', 'success');
}

// ================= USER DASHBOARD FUNCTIONS =================
function showDashboard() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    updateDashboard();
}

function showAdminDashboard() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'block';
}

function showPage(pageId) {
    const pages = document.querySelectorAll('#dashboard .page');
    pages.forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    const sidebarItems = document.querySelectorAll('#dashboard .sidebar li');
    sidebarItems.forEach(item => item.classList.remove('active'));
    
    const pageMap = {
        'dashboardPage': 0,
        'activationPage': 1,
        'activationHistoryPage': 2,
        'profilePage': 3,
        'kycPage': 4,
        'changePasswordPage': 5,
        'addFundPage': 6,
        'fundReportPage': 7,
        'withdrawalPage': 8,
        'withdrawalReportPage': 9,
        'taskPage': 10
    };
    
    if (pageMap[pageId] !== undefined) {
        sidebarItems[pageMap[pageId]].classList.add('active');
    }
    
    if (pageId === 'taskPage') {
        loadTaskPage();
    } else if (pageId === 'activationHistoryPage') {
        loadActivationHistory();
    } else if (pageId === 'profilePage') {
        loadProfilePage();
    } else if (pageId === 'fundReportPage') {
        loadFundReport();
    } else if (pageId === 'withdrawalReportPage') {
        loadWithdrawalReport();
    }
}

function showAdminPage(pageId) {
    const pages = document.querySelectorAll('#adminDashboard .page');
    pages.forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    if (pageId === 'adminUsersPage') {
        loadAllUsers();
    } else if (pageId === 'adminDepositsPage') {
        loadAdminDeposits();
    } else if (pageId === 'adminWithdrawalsPage') {
        loadAdminWithdrawals();
    } else if (pageId === 'adminTransactionsPage') {
        loadAdminTransactions();
    } else if (pageId === 'adminNotificationsPage') {
        loadNotificationUsers();
    }
}

async function updateDashboard() {
    if (!userData) return;
    
    // Update user info
    document.getElementById('userName').innerText = userData.name;
    document.getElementById('userId').innerText = userData.userId;
    document.getElementById('joinDate').innerText = userData.joinDate;
    document.getElementById('userAvatar').innerText = userData.name.charAt(0).toUpperCase();
    document.getElementById('userBalance').innerText = `₹${userData.balance}`;
    document.getElementById('userFund').innerText = `₹${userData.fund}`;
    document.getElementById('totalIncome').innerText = `₹${userData.totalIncome}`;
    document.getElementById('todayIncome').innerText = `₹${userData.todayIncome}`;
    document.getElementById('referralIncome').innerText = `₹${userData.referralIncome}`;
    document.getElementById('totalTasks').innerText = userData.totalTasks;
    document.getElementById('referralCount').innerText = userData.referrals;
    document.getElementById('userRank').innerText = userData.rank;
    
    // Update referral link
    const refLink = `https://capitalrise.com/register?ref=${userData.userId}`;
    document.getElementById('refLink').value = refLink;
    
    // Update status badge
    const statusBadge = document.getElementById('userStatusBadge');
    if (userData.package === "None") {
        statusBadge.innerText = "Inactive";
        statusBadge.style.background = "linear-gradient(90deg, #ff6b6b, #ff4757)";
    } else {
        statusBadge.innerText = "Active";
        statusBadge.style.background = "linear-gradient(90deg, #1db954, #22e06d)";
    }
}

// ================= PACKAGE FUNCTIONS =================
async function activatePackage(amount, packageName) {
    if (!userData) return;
    
    if (userData.balance < amount) {
        showToast(`Insufficient funds! You need ₹${amount}`, 'error');
        return;
    }
    
    if (confirm(`Activate ${packageName} package for ₹${amount}?`)) {
        showLoading();
        
        try {
            const updates = {};
            const packageId = 'PKG' + Date.now();
            
            // Calculate validity
            const validityDate = new Date();
            validityDate.setDate(validityDate.getDate() + 30);
            
            // Update user data
            updates[`users/${currentUser.uid}/balance`] = userData.balance - amount;
            updates[`users/${currentUser.uid}/fund`] = userData.fund + amount;
            updates[`users/${currentUser.uid}/package`] = packageName;
            updates[`users/${currentUser.uid}/activationHistory/${packageId}`] = {
                id: packageId,
                date: new Date().toLocaleString(),
                package: packageName,
                amount: amount,
                status: "Active",
                validityTill: validityDate.toLocaleDateString('en-US')
            };
            
            // Save transaction for admin
            const transactionId = 'TRX' + Date.now();
            updates[`adminTransactions/${transactionId}`] = {
                type: 'package_activation',
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: userData.email,
                amount: amount,
                package: packageName,
                description: `${packageName} Package Activation`,
                timestamp: Date.now(),
                status: 'completed'
            };
            
            // Save to admin logs
            updates[`adminLogs/packageActivations/${packageId}`] = {
                userId: currentUser.uid,
                userName: userData.name,
                userEmail: userData.email,
                package: packageName,
                amount: amount,
                timestamp: Date.now(),
                validityTill: validityDate.getTime()
            };
            
            await database.ref().update(updates);
            
            // Send notification to admin
            await createNotification('package', {
                userId: currentUser.uid,
                userName: userData.name,
                amount: amount,
                package: packageName
            });
            
            // Update local data
            userData.balance -= amount;
            userData.fund += amount;
            userData.package = packageName;
            
            hideLoading();
            showToast(`${packageName} package activated successfully!`, 'success');
            updateDashboard();
            
        } catch (error) {
            hideLoading();
            showToast(`Error activating package: ${error.message}`, 'error');
        }
    }
}

function activateSelectedPackage() {
    const select = document.getElementById('activationPackageSelect');
    const amount = parseInt(select.value);
    const packageName = select.options[select.selectedIndex].text.split(' - ')[0];
    activatePackage(amount, packageName);
}

function updateActivationDetails() {
    const select = document.getElementById('activationPackageSelect');
    const detailsDiv = document.getElementById('activationDetails');
    detailsDiv.innerHTML = `
        <h4 style="color:#a970ff; margin-bottom:15px;">Package Benefits:</h4>
        <div class="pkg-features">
            <li><i class="fas fa-check-circle"></i> Daily Task Income: 5%</li>
            <li><i class="fas fa-check-circle"></i> Referral Commission: 10%</li>
            <li><i class="fas fa-check-circle"></i> Withdrawal in 24-48 hours</li>
            <li><i class="fas fa-check-circle"></i> Daily 15 Clicks Task</li>
            <li><i class="fas fa-check-circle"></i> Validity: 30 Days</li>
        </div>
    `;
}

// ================= TASK FUNCTIONS =================
function loadTaskPage() {
    if (!userData) return;
    
    // Reset tasks if new day
    const today = new Date().toLocaleDateString();
    if (userData.dailyTasks.lastTaskDate !== today) {
        taskClickCount = 0;
    } else {
        taskClickCount = userData.dailyTasks.clicksCompleted || 0;
    }
    
    updateTaskUI();
}

function updateTaskUI() {
    const progressText = document.getElementById('task-progress-text');
    const progressFill = document.getElementById('task-progress-fill');
    const clickButton = document.getElementById('task-click-button');
    
    progressText.textContent = `Progress: ${taskClickCount}/${taskTotalClicksNeeded} clicks`;
    progressFill.style.width = `${(taskClickCount / taskTotalClicksNeeded) * 100}%`;
    
    if (taskClickCount >= taskTotalClicksNeeded) {
        clickButton.disabled = true;
        clickButton.textContent = "Task Completed!";
    } else {
        clickButton.disabled = false;
        clickButton.textContent = "Click Here";
    }
}

async function handleTaskClick() {
    if (!userData || !currentUser) return;
    
    // Check if user has active package
    if (userData.package === "None") {
        showToast("Please activate a package first!", 'error');
        showPage('activationPage');
        return;
    }
    
    // Check if tasks completed for today
    if (taskClickCount >= taskTotalClicksNeeded) {
        showToast("You have completed today's tasks!", 'info');
        return;
    }
    
    showLoading();
    
    try {
        taskClickCount++;
        const today = new Date().toLocaleDateString();
        
        // Calculate task reward (5% of fund divided by 15 clicks)
        const dailyReward = userData.fund * 0.05;
        const perClickReward = dailyReward / taskTotalClicksNeeded;
        
        // Update user data
        const updates = {};
        updates[`users/${currentUser.uid}/dailyTasks/lastTaskDate`] = today;
        updates[`users/${currentUser.uid}/dailyTasks/clicksCompleted`] = taskClickCount;
        updates[`users/${currentUser.uid}/dailyTasks/todayIncome`] = (userData.dailyTasks.todayIncome || 0) + perClickReward;
        updates[`users/${currentUser.uid}/balance`] = userData.balance + perClickReward;
        updates[`users/${currentUser.uid}/totalIncome`] = userData.totalIncome + perClickReward;
        updates[`users/${currentUser.uid}/todayIncome`] = (userData.todayIncome || 0) + perClickReward;
        updates[`users/${currentUser.uid}/totalTasks`] = (userData.totalTasks || 0) + 1;
        
        // Save to admin logs
        const taskId = 'TASK' + Date.now();
        updates[`adminLogs/tasks/${taskId}`] = {
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            taskNumber: taskClickCount,
            reward: perClickReward,
            timestamp: Date.now(),
            package: userData.package
        };
        
        await database.ref().update(updates);
        
        // Send notification to admin when all tasks completed
        if (taskClickCount >= taskTotalClicksNeeded) {
            await createNotification('task_completed', {
                userId: currentUser.uid,
                userName: userData.name,
                amount: dailyReward.toFixed(2)
            });
        }
        
        // Update local data
        userData.balance += perClickReward;
        userData.totalIncome += perClickReward;
        userData.todayIncome += perClickReward;
        userData.totalTasks += 1;
        userData.dailyTasks = {
            lastTaskDate: today,
            clicksCompleted: taskClickCount,
            todayIncome: (userData.dailyTasks.todayIncome || 0) + perClickReward
        };
        
        hideLoading();
        
        if (taskClickCount >= taskTotalClicksNeeded) {
            showToast(`Congratulations! Daily tasks completed. ₹${dailyReward.toFixed(2)} earned.`, 'success');
        } else {
            showToast(`Click completed! ₹${perClickReward.toFixed(2)} added. ${taskTotalClicksNeeded - taskClickCount} clicks remaining.`, 'success');
        }
        
        updateTaskUI();
        updateDashboard();
        
    } catch (error) {
        hideLoading();
        showToast(`Error processing task: ${error.message}`, 'error');
    }
}

// ================= ADMIN FUNCTIONS =================
async function updateAdminDashboard() {
    try {
        const usersSnapshot = await database.ref('users').once('value');
        let totalUsers = 0;
        let todayUsers = 0;
        let totalBalance = 0;
        let totalDeposits = 0;
        let totalWithdrawals = 0;
        let pendingWithdrawals = 0;
        let html = '';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        usersSnapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            totalUsers++;
            totalBalance += user.balance || 0;
            totalDeposits += user.fund || 0;
            
            // Check if user registered today
            if (user.joinTimestamp && user.joinTimestamp >= today.getTime()) {
                todayUsers++;
            }
            
            html += `
                <tr>
                    <td>${user.userId}</td>
                    <td>${user.name}</td>
                    <td>₹${user.balance || 0}</td>
                    <td>${user.package}</td>
                    <td>${user.status}</td>
                    <td>${user.joinDate}</td>
                    <td>
                        <button class="btn-sm" onclick="sendUserNotification('${childSnapshot.key}')">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="btn-sm btn-success" onclick="viewUserDetails('${childSnapshot.key}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        // Get today's deposits and withdrawals
        const todayDeposits = await getTodayTransactions('deposit');
        const todayWithdrawals = await getTodayTransactions('withdrawal');
        
        document.getElementById('adminTotalUsers').innerText = totalUsers;
        document.getElementById('adminTodayUsers').innerText = todayUsers;
        document.getElementById('adminTotalDeposits').innerText = `₹${totalDeposits}`;
        document.getElementById('adminTodayDeposits').innerText = `₹${todayDeposits}`;
        document.getElementById('adminTotalWithdrawals').innerText = `₹${totalWithdrawals}`;
        document.getElementById('adminPendingWithdrawals').innerText = pendingWithdrawals;
        document.getElementById('adminPlatformBalance').innerText = `₹${totalDeposits - totalWithdrawals}`;
        document.getElementById('adminUsersList').innerHTML = html;
        
    } catch (error) {
        console.error("Error updating admin dashboard:", error);
    }
}

async function getTodayTransactions(type) {
    try {
        let total = 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const snapshot = await database.ref('adminTransactions').once('value');
        snapshot.forEach((childSnapshot) => {
            const transaction = childSnapshot.val();
            if (transaction.type === type && transaction.timestamp >= today.getTime()) {
                total += transaction.amount || 0;
            }
        });
        
        return total;
    } catch (error) {
        return 0;
    }
}

async function loadAllUsers() {
    try {
        const snapshot = await database.ref('users').once('value');
        let html = '';
        
        snapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            html += `
                <tr>
                    <td>${user.userId}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.mobile}</td>
                    <td>₹${user.balance}</td>
                    <td>${user.package}</td>
                    <td>
                        <span class="user-status" style="
                            background: ${user.status === 'Active' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 'linear-gradient(90deg, #ff6b6b, #ff4757)'};
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                        ">${user.status}</span>
                    </td>
                    <td>
                        <button class="btn-sm" onclick="toggleUserStatus('${childSnapshot.key}', '${user.status}')">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button class="btn-sm btn-success" onclick="editUserBalance('${childSnapshot.key}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('allUsersTable').innerHTML = html;
    } catch (error) {
        console.error("Error loading users:", error);
    }
}

async function toggleUserStatus(userId, currentStatus) {
    const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
    
    if (confirm(`Change user status to ${newStatus}?`)) {
        showLoading();
        
        try {
            await database.ref(`users/${userId}`).update({ status: newStatus });
            
            // Log to admin
            await database.ref('adminLogs/userStatusChanges').push().set({
                adminId: currentAdmin ? currentAdmin.uid : 'system',
                userId: userId,
                oldStatus: currentStatus,
                newStatus: newStatus,
                timestamp: Date.now()
            });
            
            hideLoading();
            showToast(`User status changed to ${newStatus}`, 'success');
            loadAllUsers();
        } catch (error) {
            hideLoading();
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function editUserBalance(userId) {
    const newBalance = prompt("Enter new balance:");
    if (newBalance === null) return;
    
    const amount = parseFloat(newBalance);
    if (isNaN(amount) || amount < 0) {
        showToast("Invalid amount", 'error');
        return;
    }
    
    showLoading();
    
    try {
        await database.ref(`users/${userId}`).update({ balance: amount });
        
        // Log to admin
        await database.ref('adminLogs/balanceChanges').push().set({
            adminId: currentAdmin ? currentAdmin.uid : 'system',
            userId: userId,
            newBalance: amount,
            timestamp: Date.now()
        });
        
        hideLoading();
        showToast("Balance updated successfully", 'success');
        loadAllUsers();
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

// ================= UTILITY FUNCTIONS =================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const adminSidebar = document.getElementById('adminSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    if (sidebar) sidebar.classList.toggle('active');
    if (adminSidebar) adminSidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const adminSidebar = document.getElementById('adminSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    if (sidebar) sidebar.classList.remove('active');
    if (adminSidebar) adminSidebar.classList.remove('active');
    overlay.classList.remove('active');
}

// ================= NOTIFICATION SYSTEM =================
async function initNotificationSystem() {
    // Setup real-time listener for notifications
    database.ref('notifications').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        notifications = [];
        notificationCount = 0;
        
        snapshot.forEach((childSnapshot) => {
            const notification = childSnapshot.val();
            notification.id = childSnapshot.key;
            notifications.unshift(notification); // Add to beginning
            
            // Count unread notifications for current user/admin
            if (currentAdmin) {
                // Admin sees all notifications
                if (!notification.adminRead) notificationCount++;
            } else if (currentUser && notification.userId === currentUser.uid && !notification.userRead) {
                notificationCount++;
            }
        });
        
        updateNotificationBadge();
    });
}

function updateNotificationBadge() {
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.textContent = notificationCount > 0 ? notificationCount : '0';
        badge.style.display = notificationCount > 0 ? 'flex' : 'none';
    }
}

function showNotificationModal() {
    const modal = document.getElementById('notificationModal');
    modal.style.display = 'flex';
    loadNotificationsModal();
}

function closeNotificationModal() {
    const modal = document.getElementById('notificationModal');
    modal.style.display = 'none';
}

async function loadNotificationsModal() {
    const notificationsList = document.getElementById('notificationsList');
    
    // Filter notifications for current user
    let userNotifications = [];
    if (currentAdmin) {
        // Admin sees all notifications
        userNotifications = notifications;
    } else if (currentUser) {
        // User sees only their notifications
        userNotifications = notifications.filter(n => n.userId === currentUser.uid);
    }
    
    if (userNotifications.length === 0) {
        notificationsList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #888;">
                <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                <p>No notifications yet</p>
            </div>
        `;
    } else {
        let html = '';
        userNotifications.forEach((notification) => {
            const isUnread = currentAdmin ? !notification.adminRead : !notification.userRead;
            const timeAgo = getTimeAgo(notification.timestamp);
            
            html += `
                <div class="notification-item" style="
                    background: ${isUnread ? 'rgba(169, 112, 255, 0.1)' : 'rgba(255,255,255,0.03)'};
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border-left: 3px solid ${isUnread ? '#a970ff' : 'transparent'};
                    cursor: pointer;
                    transition: all 0.3s;
                " onclick="viewNotification('${notification.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0; color: white; font-size: 14px;">
                                ${notification.title}
                                ${isUnread ? '<span style="display: inline-block; width: 8px; height: 8px; background: #a970ff; border-radius: 50%; margin-left: 8px;"></span>' : ''}
                            </h4>
                            <p style="margin: 0; color: #aaa; font-size: 13px;">${notification.message}</p>
                            <div style="display: flex; align-items: center; margin-top: 8px; font-size: 12px; color: #666;">
                                <i class="far fa-clock" style="margin-right: 5px;"></i>
                                ${timeAgo}
                                ${notification.userName ? `<span style="margin-left: 10px;"><i class="fas fa-user"></i> ${notification.userName}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        notificationsList.innerHTML = html;
    }
}

async function viewNotification(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (!notification) return;
    
    // Mark as read
    if (currentAdmin) {
        await database.ref(`notifications/${notificationId}`).update({ adminRead: true });
    } else if (currentUser) {
        await database.ref(`notifications/${notificationId}`).update({ userRead: true });
    }
}

async function markAllNotificationsAsRead() {
    showLoading();
    
    try {
        const updates = {};
        notifications.forEach(notification => {
            if (currentAdmin && !notification.adminRead) {
                updates[`notifications/${notification.id}/adminRead`] = true;
            } else if (currentUser && notification.userId === currentUser.uid && !notification.userRead) {
                updates[`notifications/${notification.id}/userRead`] = true;
            }
        });
        
        if (Object.keys(updates).length > 0) {
            await database.ref().update(updates);
            showToast('All notifications marked as read', 'success');
            closeNotificationModal();
        }
        
        hideLoading();
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

function getTimeAgo(timestamp) {
    if (!timestamp) return 'Just now';
    
    const now = new Date().getTime();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    
    return new Date(timestamp).toLocaleDateString();
}

// ================= NOTIFICATION CREATION =================
async function createNotification(type, data) {
    const notificationId = database.ref().child('notifications').push().key;
    const timestamp = Date.now();
    
    let title = '';
    let message = '';
    let userId = data.userId || (currentUser ? currentUser.uid : '');
    let userName = data.userName || (userData ? userData.name : '');
    let amount = data.amount || 0;
    let packageName = data.package || '';
    
    switch (type) {
        case 'registration':
            title = 'New User Registration';
            message = `${userName} has registered on CapitalRise. User ID: ${data.userId || 'N/A'}`;
            break;
            
        case 'package':
            title = 'Package Activated';
            message = `${userName} has activated ${packageName} package for ₹${amount}`;
            break;
            
        case 'task_completed':
            title = 'Daily Task Completed';
            message = `${userName} has completed daily tasks and earned ₹${amount}`;
            break;
            
        case 'system':
            title = data.title || 'System Notification';
            message = data.message || '';
            userId = data.userId || 'all';
            userName = data.userName || '';
            break;
            
        default:
            title = 'Notification';
            message = data.message || '';
    }
    
    const notification = {
        id: notificationId,
        type: type,
        title: title,
        message: message,
        userId: userId,
        userName: userName,
        amount: amount,
        package: packageName,
        timestamp: timestamp,
        adminRead: false,
        userRead: false
    };
    
    try {
        await database.ref(`notifications/${notificationId}`).set(notification);
        return notificationId;
    } catch (error) {
        console.error("Error creating notification:", error);
        return null;
    }
}

// ================= ADDITIONAL FUNCTIONS =================
async function loadActivationHistory() {
    if (!userData || !userData.activationHistory) return;
    
    const table = document.getElementById('activationHistoryTable');
    let html = '';
    
    Object.values(userData.activationHistory).forEach(pkg => {
        html += `
            <tr>
                <td>${pkg.id}</td>
                <td>${pkg.package}</td>
                <td>₹${pkg.amount}</td>
                <td>${pkg.date}</td>
                <td>${pkg.status}</td>
                <td>${pkg.validityTill}</td>
            </tr>
        `;
    });
    
    table.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No activation history found</td></tr>';
}

async function loadProfilePage() {
    if (!userData) return;
    
    document.getElementById('profileName').value = userData.name;
    document.getElementById('profileEmail').value = userData.email;
    document.getElementById('profileMobile').value = userData.mobile;
}

async function updateProfile() {
    const name = document.getElementById('profileName').value.trim();
    const mobile = document.getElementById('profileMobile').value.trim();
    
    if (!name || !mobile) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    showLoading();
    
    try {
        await database.ref(`users/${currentUser.uid}`).update({
            name: name,
            mobile: mobile
        });
        
        // Update local data
        userData.name = name;
        userData.mobile = mobile;
        
        // Log to admin
        await database.ref('adminLogs/profileUpdates').push().set({
            userId: currentUser.uid,
            userName: name,
            mobile: mobile,
            timestamp: Date.now()
        });
        
        hideLoading();
        showToast('Profile updated successfully', 'success');
        updateDashboard();
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function submitKYC() {
    const aadhar = document.getElementById('aadharNumber').value.trim();
    const pan = document.getElementById('panNumber').value.trim();
    const bankAccount = document.getElementById('bankAccount').value.trim();
    const ifsc = document.getElementById('ifscCode').value.trim();
    
    if (!aadhar || !pan || !bankAccount || !ifsc) {
        showToast('Please fill all KYC fields', 'error');
        return;
    }
    
    if (aadhar.length !== 12) {
        showToast('Aadhar number must be 12 digits', 'error');
        return;
    }
    
    if (pan.length !== 10) {
        showToast('PAN number must be 10 characters', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const kycData = {
            aadhar: aadhar,
            pan: pan,
            bankAccount: bankAccount,
            ifsc: ifsc,
            status: 'Pending',
            submittedAt: Date.now()
        };
        
        await database.ref(`users/${currentUser.uid}/kycDetails`).set(kycData);
        await database.ref(`users/${currentUser.uid}`).update({ kyc: 'Pending' });
        
        // Log to admin
        await database.ref('adminLogs/kycSubmissions').push().set({
            userId: currentUser.uid,
            userName: userData.name,
            kycData: kycData,
            timestamp: Date.now()
        });
        
        // Send notification to admin
        await createNotification('kyc_submitted', {
            userId: currentUser.uid,
            userName: userData.name
        });
        
        hideLoading();
        showToast('KYC submitted successfully. Waiting for admin approval.', 'success');
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function submitDeposit() {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const transactionId = document.getElementById('transactionId').value.trim();
    
    if (!amount || amount < 100) {
        showToast('Minimum deposit amount is ₹100', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const depositId = 'DEP' + Date.now();
        const depositData = {
            id: depositId,
            amount: amount,
            method: method,
            transactionId: transactionId,
            status: 'Pending',
            date: new Date().toLocaleString(),
            timestamp: Date.now()
        };
        
        // Save to user
        await database.ref(`users/${currentUser.uid}/deposits/${depositId}`).set(depositData);
        
        // Save to admin logs
        await database.ref('adminLogs/deposits').child(depositId).set({
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            ...depositData
        });
        
        // Create admin transaction
        await database.ref('adminTransactions').push().set({
            type: 'deposit',
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            amount: amount,
            method: method,
            transactionId: transactionId,
            status: 'pending',
            timestamp: Date.now()
        });
        
        // Send notification to admin
        await createNotification('deposit', {
            userId: currentUser.uid,
            userName: userData.name,
            amount: amount
        });
        
        hideLoading();
        showToast('Deposit request submitted. Admin will approve it soon.', 'success');
        document.getElementById('depositAmount').value = '';
        document.getElementById('transactionId').value = '';
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function loadFundReport() {
    if (!userData || !userData.deposits) return;
    
    const table = document.getElementById('fundReportTable');
    let html = '';
    
    Object.values(userData.deposits).forEach(deposit => {
        html += `
            <tr>
                <td>${deposit.date}</td>
                <td>₹${deposit.amount}</td>
                <td>${deposit.method}</td>
                <td>${deposit.transactionId || 'N/A'}</td>
                <td>
                    <span style="
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        background: ${deposit.status === 'Approved' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 
                                   deposit.status === 'Rejected' ? 'linear-gradient(90deg, #ff6b6b, #ff4757)' : 
                                   'linear-gradient(90deg, #ffa502, #ff7f00)'};
                    ">${deposit.status}</span>
                </td>
            </tr>
        `;
    });
    
    table.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No deposit history found</td></tr>';
}

async function submitWithdrawal() {
    const amount = parseFloat(document.getElementById('withdrawalAmount').value);
    
    if (!amount || amount < 100) {
        showToast('Minimum withdrawal amount is ₹100', 'error');
        return;
    }
    
    if (amount > userData.balance) {
        showToast('Insufficient balance', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const withdrawalId = 'WDL' + Date.now();
        const withdrawalData = {
            id: withdrawalId,
            amount: amount,
            method: 'Bank Transfer',
            status: 'Pending',
            date: new Date().toLocaleString(),
            timestamp: Date.now()
        };
        
        // Save to user
        await database.ref(`users/${currentUser.uid}/withdrawals/${withdrawalId}`).set(withdrawalData);
        
        // Save to admin logs
        await database.ref('adminLogs/withdrawals').child(withdrawalId).set({
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            ...withdrawalData
        });
        
        // Create admin transaction
        await database.ref('adminTransactions').push().set({
            type: 'withdrawal',
            userId: currentUser.uid,
            userName: userData.name,
            userEmail: userData.email,
            amount: amount,
            method: 'Bank Transfer',
            status: 'pending',
            timestamp: Date.now()
        });
        
        // Send notification to admin
        await createNotification('withdrawal', {
            userId: currentUser.uid,
            userName: userData.name,
            amount: amount
        });
        
        hideLoading();
        showToast('Withdrawal request submitted. Admin will process it within 24-48 hours.', 'success');
        document.getElementById('withdrawalAmount').value = '';
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function loadWithdrawalReport() {
    if (!userData || !userData.withdrawals) return;
    
    const table = document.getElementById('withdrawalReportTable');
    let html = '';
    
    Object.values(userData.withdrawals).forEach(withdrawal => {
        html += `
            <tr>
                <td>${withdrawal.date}</td>
                <td>₹${withdrawal.amount}</td>
                <td>${withdrawal.method}</td>
                <td>
                    <span style="
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        background: ${withdrawal.status === 'Approved' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 
                                   withdrawal.status === 'Rejected' ? 'linear-gradient(90deg, #ff6b6b, #ff4757)' : 
                                   'linear-gradient(90deg, #ffa502, #ff7f00)'};
                    ">${withdrawal.status}</span>
                </td>
                <td>${withdrawal.transactionId || 'N/A'}</td>
            </tr>
        `;
    });
    
    table.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No withdrawal history found</td></tr>';
}

async function loadAdminDeposits() {
    try {
        const snapshot = await database.ref('adminLogs/deposits').once('value');
        let html = '';
        
        snapshot.forEach((childSnapshot) => {
            const deposit = childSnapshot.val();
            html += `
                <tr>
                    <td>${deposit.userId || 'N/A'}</td>
                    <td>${deposit.userName}</td>
                    <td>₹${deposit.amount}</td>
                    <td>${deposit.method}</td>
                    <td>${deposit.transactionId || 'N/A'}</td>
                    <td>${new Date(deposit.timestamp).toLocaleString()}</td>
                    <td>
                        <span style="
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            background: ${deposit.status === 'Approved' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 
                                       deposit.status === 'Rejected' ? 'linear-gradient(90deg, #ff6b6b, #ff4757)' : 
                                       'linear-gradient(90deg, #ffa502, #ff7f00)'};
                        ">${deposit.status}</span>
                    </td>
                    <td>
                        ${deposit.status === 'Pending' ? `
                            <button class="btn-sm btn-success" onclick="approveDeposit('${deposit.id}', '${deposit.userId}', ${deposit.amount})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-sm btn-danger" onclick="rejectDeposit('${deposit.id}', '${deposit.userId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : 'Completed'}
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('adminDepositsTable').innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No deposit requests found</td></tr>';
    } catch (error) {
        console.error("Error loading deposits:", error);
    }
}

async function approveDeposit(depositId, userId, amount) {
    if (confirm(`Approve deposit of ₹${amount}?`)) {
        showLoading();
        
        try {
            // Update deposit status
            await database.ref(`users/${userId}/deposits/${depositId}`).update({ status: 'Approved' });
            await database.ref(`adminLogs/deposits/${depositId}`).update({ status: 'Approved' });
            
            // Update user balance
            const userSnapshot = await database.ref(`users/${userId}`).once('value');
            const user = userSnapshot.val();
            const newBalance = (user.balance || 0) + amount;
            
            await database.ref(`users/${userId}`).update({ balance: newBalance });
            
            // Update admin transaction
            const transactionsSnapshot = await database.ref('adminTransactions').once('value');
            transactionsSnapshot.forEach((childSnapshot) => {
                const transaction = childSnapshot.val();
                if (transaction.type === 'deposit' && transaction.amount === amount && transaction.userId === userId) {
                    database.ref(`adminTransactions/${childSnapshot.key}`).update({ status: 'completed' });
                }
            });
            
            // Send notification to user
            await createNotification('deposit_approved', {
                userId: userId,
                userName: user.name,
                amount: amount
            });
            
            hideLoading();
            showToast('Deposit approved successfully', 'success');
            loadAdminDeposits();
        } catch (error) {
            hideLoading();
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function rejectDeposit(depositId, userId) {
    if (confirm('Reject this deposit request?')) {
        showLoading();
        
        try {
            await database.ref(`users/${userId}/deposits/${depositId}`).update({ status: 'Rejected' });
            await database.ref(`adminLogs/deposits/${depositId}`).update({ status: 'Rejected' });
            
            // Update admin transaction
            const transactionsSnapshot = await database.ref('adminTransactions').once('value');
            transactionsSnapshot.forEach((childSnapshot) => {
                const transaction = childSnapshot.val();
                if (transaction.type === 'deposit' && transaction.userId === userId) {
                    database.ref(`adminTransactions/${childSnapshot.key}`).update({ status: 'rejected' });
                }
            });
            
            hideLoading();
            showToast('Deposit rejected', 'success');
            loadAdminDeposits();
        } catch (error) {
            hideLoading();
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function loadAdminWithdrawals() {
    try {
        const snapshot = await database.ref('adminLogs/withdrawals').once('value');
        let html = '';
        
        snapshot.forEach((childSnapshot) => {
            const withdrawal = childSnapshot.val();
            html += `
                <tr>
                    <td>${withdrawal.userId || 'N/A'}</td>
                    <td>${withdrawal.userName}</td>
                    <td>₹${withdrawal.amount}</td>
                    <td>${withdrawal.method}</td>
                    <td>${withdrawal.bankAccount || 'N/A'}</td>
                    <td>${new Date(withdrawal.timestamp).toLocaleString()}</td>
                    <td>
                        <span style="
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            background: ${withdrawal.status === 'Approved' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 
                                       withdrawal.status === 'Rejected' ? 'linear-gradient(90deg, #ff6b6b, #ff4757)' : 
                                       'linear-gradient(90deg, #ffa502, #ff7f00)'};
                        ">${withdrawal.status}</span>
                    </td>
                    <td>
                        ${withdrawal.status === 'Pending' ? `
                            <button class="btn-sm btn-success" onclick="approveWithdrawal('${withdrawal.id}', '${withdrawal.userId}', ${withdrawal.amount})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-sm btn-danger" onclick="rejectWithdrawal('${withdrawal.id}', '${withdrawal.userId}', ${withdrawal.amount})">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : 'Completed'}
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('adminWithdrawalsTable').innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No withdrawal requests found</td></tr>';
    } catch (error) {
        console.error("Error loading withdrawals:", error);
    }
}

async function approveWithdrawal(withdrawalId, userId, amount) {
    if (confirm(`Approve withdrawal of ₹${amount}?`)) {
        showLoading();
        
        try {
            // Update withdrawal status
            await database.ref(`users/${userId}/withdrawals/${withdrawalId}`).update({ 
                status: 'Approved',
                transactionId: 'TXN' + Date.now()
            });
            await database.ref(`adminLogs/withdrawals/${withdrawalId}`).update({ 
                status: 'Approved',
                transactionId: 'TXN' + Date.now()
            });
            
            // Update user balance
            const userSnapshot = await database.ref(`users/${userId}`).once('value');
            const user = userSnapshot.val();
            const newBalance = (user.balance || 0) - amount;
            
            if (newBalance < 0) {
                throw new Error('Insufficient balance');
            }
            
            await database.ref(`users/${userId}`).update({ balance: newBalance });
            
            // Update admin transaction
            const transactionsSnapshot = await database.ref('adminTransactions').once('value');
            transactionsSnapshot.forEach((childSnapshot) => {
                const transaction = childSnapshot.val();
                if (transaction.type === 'withdrawal' && transaction.amount === amount && transaction.userId === userId) {
                    database.ref(`adminTransactions/${childSnapshot.key}`).update({ 
                        status: 'completed',
                        transactionId: 'TXN' + Date.now()
                    });
                }
            });
            
            // Send notification to user
            await createNotification('withdrawal_approved', {
                userId: userId,
                userName: user.name,
                amount: amount
            });
            
            hideLoading();
            showToast('Withdrawal approved successfully', 'success');
            loadAdminWithdrawals();
        } catch (error) {
            hideLoading();
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function rejectWithdrawal(withdrawalId, userId, amount) {
    if (confirm('Reject this withdrawal request?')) {
        showLoading();
        
        try {
            await database.ref(`users/${userId}/withdrawals/${withdrawalId}`).update({ status: 'Rejected' });
            await database.ref(`adminLogs/withdrawals/${withdrawalId}`).update({ status: 'Rejected' });
            
            // Update admin transaction
            const transactionsSnapshot = await database.ref('adminTransactions').once('value');
            transactionsSnapshot.forEach((childSnapshot) => {
                const transaction = childSnapshot.val();
                if (transaction.type === 'withdrawal' && transaction.userId === userId) {
                    database.ref(`adminTransactions/${childSnapshot.key}`).update({ status: 'rejected' });
                }
            });
            
            // Send notification to user
            await createNotification('withdrawal_rejected', {
                userId: userId,
                userName: userData.name,
                amount: amount
            });
            
            hideLoading();
            showToast('Withdrawal rejected', 'success');
            loadAdminWithdrawals();
        } catch (error) {
            hideLoading();
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function loadAdminTransactions() {
    try {
        const snapshot = await database.ref('adminTransactions').orderByChild('timestamp').once('value');
        let html = '';
        
        snapshot.forEach((childSnapshot) => {
            const transaction = childSnapshot.val();
            html += `
                <tr>
                    <td>${new Date(transaction.timestamp).toLocaleString()}</td>
                    <td>${transaction.userId || 'N/A'}</td>
                    <td>${transaction.userName}</td>
                    <td>
                        <span style="
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            background: ${transaction.type === 'registration' ? 'linear-gradient(90deg, #6c5ce7, #a29bfe)' :
                                       transaction.type === 'package_activation' ? 'linear-gradient(90deg, #00b894, #00cec9)' :
                                       transaction.type === 'deposit' ? 'linear-gradient(90deg, #0984e3, #74b9ff)' :
                                       transaction.type === 'withdrawal' ? 'linear-gradient(90deg, #e17055, #fab1a0)' :
                                       'linear-gradient(90deg, #636e72, #b2bec3)'};
                        ">${transaction.type}</span>
                    </td>
                    <td>₹${transaction.amount || 0}</td>
                    <td>${transaction.description || 'N/A'}</td>
                    <td>
                        <span style="
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            background: ${transaction.status === 'completed' ? 'linear-gradient(90deg, #1db954, #22e06d)' : 
                                       transaction.status === 'rejected' ? 'linear-gradient(90deg, #ff6b6b, #ff4757)' : 
                                       'linear-gradient(90deg, #ffa502, #ff7f00)'};
                        ">${transaction.status}</span>
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('adminTransactionsTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No transactions found</td></tr>';
    } catch (error) {
        console.error("Error loading transactions:", error);
    }
}

async function loadNotificationUsers() {
    try {
        const snapshot = await database.ref('users').once('value');
        let html = '<option value="">Select User</option>';
        
        snapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            html += `<option value="${childSnapshot.key}">${user.name} (${user.userId})</option>`;
        });
        
        document.getElementById('specificUser').innerHTML = html;
        
        // Show/hide specific user dropdown
        document.getElementById('notificationUsers').addEventListener('change', function() {
            const specificUserDiv = document.getElementById('specificUserDiv');
            specificUserDiv.style.display = this.value === 'specific' ? 'block' : 'none';
        });
    } catch (error) {
        console.error("Error loading users for notifications:", error);
    }
}

async function sendAdminNotification() {
    const userType = document.getElementById('notificationUsers').value;
    const specificUserId = document.getElementById('specificUser').value;
    const title = document.getElementById('notificationTitle').value.trim();
    const message = document.getElementById('notificationMessage').value.trim();
    
    if (!title || !message) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    showLoading();
    
    try {
        if (userType === 'specific' && specificUserId) {
            // Send to specific user
            const userSnapshot = await database.ref(`users/${specificUserId}`).once('value');
            const user = userSnapshot.val();
            
            await createNotification('system', {
                userId: specificUserId,
                userName: user.name,
                title: title,
                message: message
            });
            
            hideLoading();
            showToast(`Notification sent to ${user.name}`, 'success');
        } else {
            // Send to all users
            const snapshot = await database.ref('users').once('value');
            const promises = [];
            
            snapshot.forEach((childSnapshot) => {
                const user = childSnapshot.val();
                if (userType === 'all' || 
                   (userType === 'active' && user.status === 'Active') ||
                   (userType === 'inactive' && user.status !== 'Active')) {
                    
                    promises.push(createNotification('system', {
                        userId: childSnapshot.key,
                        userName: user.name,
                        title: title,
                        message: message
                    }));
                }
            });
            
            await Promise.all(promises);
            hideLoading();
            showToast(`Notification sent to ${promises.length} users`, 'success');
        }
        
        // Clear form
        document.getElementById('notificationTitle').value = '';
        document.getElementById('notificationMessage').value = '';
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function saveAdminSettings() {
    const platformName = document.getElementById('platformName').value.trim();
    const minDeposit = parseFloat(document.getElementById('minDeposit').value);
    const minWithdrawal = parseFloat(document.getElementById('minWithdrawal').value);
    const taskReward = parseFloat(document.getElementById('taskReward').value);
    const referralCommission = parseFloat(document.getElementById('referralCommission').value);
    
    showLoading();
    
    try {
        const settings = {
            platformName: platformName,
            minDeposit: minDeposit,
            minWithdrawal: minWithdrawal,
            taskReward: taskReward,
            referralCommission: referralCommission,
            updatedAt: Date.now()
        };
        
        await database.ref('adminSettings').set(settings);
        
        hideLoading();
        showToast('Settings saved successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

// ================= REFERRAL FUNCTIONS =================
function copyReferralLink() {
    const refLink = document.getElementById('refLink');
    refLink.select();
    document.execCommand('copy');
    showToast('Referral link copied to clipboard!', 'success');
}

function shareOnTelegram() {
    const text = encodeURIComponent(`Join CapitalRise Trading Platform using my referral link: ${document.getElementById('refLink').value}`);
    window.open(`https://t.me/share/url?url=${text}`, '_blank');
}

function shareOnWhatsApp() {
    const text = encodeURIComponent(`Join CapitalRise Trading Platform using my referral link: ${document.getElementById('refLink').value}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareOnFacebook() {
    const url = encodeURIComponent(document.getElementById('refLink').value);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

// ================= CHANGE PASSWORD =================
async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showToast('New password must be at least 6 characters', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
    }
    
    showLoading();
    
    try {
        // Reauthenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await auth.currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await auth.currentUser.updatePassword(newPassword);
        
        hideLoading();
        showToast('Password changed successfully', 'success');
        
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

// ================= VIEW USER DETAILS (ADMIN) =================
async function viewUserDetails(userId) {
    try {
        const userSnapshot = await database.ref(`users/${userId}`).once('value');
        const user = userSnapshot.val();
        
        const details = `
            User ID: ${user.userId}
            Name: ${user.name}
            Email: ${user.email}
            Mobile: ${user.mobile}
            Balance: ₹${user.balance}
            Fund: ₹${user.fund}
            Package: ${user.package}
            Status: ${user.status}
            KYC: ${user.kyc}
            Referrals: ${user.referrals}
            Total Income: ₹${user.totalIncome}
            Join Date: ${user.joinDate}
            Last Login: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A'}
        `;
        
        alert(details);
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

// ================= SEND USER NOTIFICATION (ADMIN) =================
async function sendUserNotification(userId) {
    const title = prompt("Enter notification title:");
    if (!title) return;
    
    const message = prompt("Enter notification message:");
    if (!message) return;
    
    showLoading();
    
    try {
        await createNotification('system', {
            userId: userId,
            title: title,
            message: message
        });
        
        hideLoading();
        showToast('Notification sent successfully', 'success');
    } catch (error) {
        hideLoading();
        showToast(`Error: ${error.message}`, 'error');
    }
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('notificationModal');
    if (modal && modal.style.display === 'flex' && e.target === modal) {
        closeNotificationModal();
    }
});

// Initialize
showToast('Welcome to CapitalRise Trading Platform!', 'info');
</script>
</body>
</html>
